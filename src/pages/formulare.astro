---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { actions } from 'astro:actions';
import { ADMIN_PASSWORD } from 'astro:env/server';

type Message = {
  id: number;
  form: string;
  name: string;
  email: string;
  telephone: string | null;
  message: string;
  created_at: string;
};

// Handle action results — redirect on success to clear POST
const loginResult = Astro.getActionResult(actions.adminLogin);
const logoutResult = Astro.getActionResult(actions.adminLogout);
const deleteResult = Astro.getActionResult(actions.adminDeleteMessage);

if ((loginResult && !loginResult.error) || (logoutResult && !logoutResult.error) || (deleteResult && !deleteResult.error)) {
  return Astro.redirect('/formulare');
}

// Check session
async function hashToken(password: string): Promise<string> {
  const data = new TextEncoder().encode(password + ':sklenarstvi-admin-salt');
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}
const expectedToken = await hashToken(ADMIN_PASSWORD);
const authenticated = Astro.cookies.get('admin_session')?.value === expectedToken;

let messages: Message[] = [];
if (authenticated) {
  const db = Astro.locals.runtime.env.DB;
  const result = await db.prepare('SELECT * FROM messages ORDER BY created_at DESC').all<Message>();
  messages = result.results;
}

const loginError = loginResult?.error?.message || '';
---

<BaseLayout title="Formuláře – Sklenářství Ruská" description="Správa formulářů" currentPath="/formulare">
  <meta slot="head" name="robots" content="noindex, nofollow" />
  <div class="admin-page">
    {authenticated ? (
      <div class="admin-content">
        <div class="admin-header">
          <h1>Přijaté zprávy ({messages.length})</h1>
          <form method="POST" action={actions.adminLogout}>
            <button type="submit" class="btn-logout">Odhlásit se</button>
          </form>
        </div>

        {messages.length === 0 ? (
          <p class="empty">Zatím žádné zprávy.</p>
        ) : (
          <div class="messages-list">
            {messages.map((msg) => (
              <details class="message-card">
                <summary class="message-summary">
                  <span class="message-id">#{msg.id}</span>
                  <span class="message-form">{msg.form === 'poradna' ? 'Poradna' : 'Kontakt'}</span>
                  <span class="message-name">{msg.name}</span>
                  <time>{new Date(msg.created_at + 'Z').toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' })}</time>
                </summary>
                <div class="message-details">
                  <div class="message-row">
                    <strong>Jméno:</strong> {msg.name}
                  </div>
                  <div class="message-row">
                    <strong>E-mail:</strong> <a href={`mailto:${msg.email}`}>{msg.email}</a>
                  </div>
                  {msg.telephone && (
                    <div class="message-row">
                      <strong>Telefon:</strong> <a href={`tel:${msg.telephone}`}>{msg.telephone}</a>
                    </div>
                  )}
                  <div class="message-row">
                    <strong>Zpráva:</strong>
                    <p class="message-text">{msg.message}</p>
                  </div>
                  <form method="POST" action={actions.adminDeleteMessage} class="message-delete" onsubmit="return confirm('Opravdu smazat zprávu?')">
                    <input type="hidden" name="messageId" value={msg.id} />
                    <button type="submit" class="btn-delete">Smazat</button>
                  </form>
                </div>
              </details>
            ))}
          </div>
        )}
      </div>
    ) : (
      <div class="login-box">
        <h1>Přihlášení</h1>
        {loginError && <p class="login-error">{loginError}</p>}
        <form method="POST" action={actions.adminLogin}>
          <label for="password">Heslo</label>
          <input type="password" id="password" name="password" required autofocus />
          <div class="turnstile-field">
            <div id="turnstile-container"></div>
            <p id="turnstile-error" class="login-error" style="display:none">Ověření nebylo dokončeno.</p>
          </div>
          <button type="submit" class="btn-login">Přihlásit se</button>
        </form>
        <script is:inline>
          (function() {
            var loaded = false;
            var turnstileReady = false;
            function loadTurnstile() {
              if (loaded) return;
              loaded = true;
              var s = document.createElement('script');
              s.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad&render=explicit';
              s.async = true;
              document.head.appendChild(s);
            }
            window.onTurnstileLoad = function() {
              var el = document.getElementById('turnstile-container');
              if (el) turnstile.render(el, {
                sitekey: '0x4AAAAAACb2orZs8ymvai7p',
                theme: 'light',
                language: 'cs',
                callback: function() { turnstileReady = true; },
                'expired-callback': function() { turnstileReady = false; },
                'error-callback': function() { turnstileReady = false; },
              });
            };
            var pw = document.getElementById('password');
            if (pw) pw.addEventListener('input', loadTurnstile, { once: true });
            var form = document.querySelector('.login-box form');
            if (form) form.addEventListener('submit', function(e) {
              var errEl = document.getElementById('turnstile-error');
              if (!turnstileReady) {
                e.preventDefault();
                if (errEl) errEl.style.display = 'block';
              } else if (errEl) {
                errEl.style.display = 'none';
              }
            });
          })();
        </script>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .admin-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
    min-height: 60vh;
  }

  /* Login */
  .login-box {
    max-width: 360px;
    margin: 80px auto;
    padding: 30px;
    border: 2px solid #000543;
    border-radius: 6px;
    background: #fff;
  }

  .login-box h1 {
    font-size: 22px;
    margin: 0 0 20px;
    color: #000543;
    text-align: center;
  }

  .login-box label {
    display: block;
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
  }

  .login-box input {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 16px;
    box-sizing: border-box;
  }

  .turnstile-field {
    margin-bottom: 16px;
  }

  .btn-login {
    width: 100%;
    padding: 12px;
    background: #000543;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
  }

  .btn-login:hover {
    background: #111;
  }

  .login-error {
    color: #dd3333;
    text-align: center;
    margin-bottom: 16px;
    font-size: 14px;
  }

  /* Admin content */
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .admin-header h1 {
    font-size: 24px;
    color: #000543;
    margin: 0;
  }

  .btn-logout {
    padding: 8px 16px;
    background: #eee;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    color: #555;
  }

  .btn-logout:hover {
    background: #ddd;
  }

  .empty {
    color: #888;
    text-align: center;
    padding: 40px 0;
    font-size: 16px;
  }

  /* Message cards */
  .messages-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message-card {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fff;
  }

  .message-summary {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    font-size: 14px;
    color: #555;
    cursor: pointer;
    list-style: none;
  }

  .message-summary::-webkit-details-marker {
    display: none;
  }

  .message-summary::before {
    content: '\25B8';
    font-size: 12px;
    color: #aaa;
    transition: transform 0.15s;
  }

  .message-card[open] > .message-summary::before {
    transform: rotate(90deg);
  }

  .message-id {
    font-weight: 600;
    color: #000543;
  }

  .message-form {
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 600;
    background: #e8e8f0;
    color: #000543;
  }

  .message-name {
    flex: 1;
    font-weight: 600;
    color: #333;
  }

  .message-summary time {
    font-size: 13px;
    color: #888;
  }

  .message-details {
    padding: 0 20px 16px;
    border-top: 1px solid #f0f0f0;
  }

  .message-row {
    padding: 4px 0;
    font-size: 15px;
    line-height: 1.5;
  }

  .message-row strong {
    color: #555;
    min-width: 80px;
    display: inline-block;
  }

  .message-row a {
    color: #000543;
    text-decoration: none;
  }

  .message-row a:hover {
    text-decoration: underline;
  }

  .message-text {
    margin-top: 4px;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.6;
  }

  .message-delete {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
  }

  .btn-delete {
    padding: 6px 14px;
    background: #fff;
    color: #cc3333;
    border: 1px solid #cc3333;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
  }

  .btn-delete:hover {
    background: #cc3333;
    color: #fff;
  }

  @media (max-width: 600px) {
    .admin-page {
      padding: 20px 12px;
    }

    .message-summary {
      flex-wrap: wrap;
    }

    .admin-header h1 {
      font-size: 20px;
    }
  }
</style>
